# PHPBoy WebAssembly Build Guide

This guide explains how to build and deploy PHPBoy for the browser using **em** (krakjoe/em).

> **Note:** PHPBoy has migrated from php-wasm to em for significantly better performance (2-4x improvement). See [em-migration.md](em-migration.md) for details.

## Overview

PHPBoy uses [em](https://github.com/krakjoe/em) to compile PHP to WebAssembly. This provides:

- **2-4x better performance** vs php-wasm
- **Smaller binary size** (~4MB vs ~8MB)
- **Direct C API access** for lower overhead
- **Optimized compilation** with -O3 flags
- **Configurable PHP build** with only needed extensions

## Quick Start

### Prerequisites

- Emscripten SDK
- PHP 8.4 source code
- Build tools (re2c, bison, autoconf)

### Build Steps

```bash
# 1. Build or obtain em binaries (see EM-BUILD-INSTRUCTIONS.md)
# This produces: php-em.js and php-em.wasm

# 2. Copy to PHPBoy
cp /path/to/php-em.* web/

# 3. Build WASM distribution
make build-wasm

# 4. Serve locally
make serve-wasm
```

## Architecture

The WebAssembly build consists of:

1. **php-em.js** - em JavaScript runtime (~600KB)
2. **php-em.wasm** - PHP WebAssembly binary (~4MB)
3. **phpboy-wasm-full.php** - Bundled emulator code (~600KB)
4. **phpboy.js** - JavaScript bridge
5. **index.html** - Web interface

### How It Works

```
Browser
  ↓ Loads
php-em.js (em runtime)
  ↓ Initializes
Module (global WebAssembly interface)
  ↓ Used by
phpboy.js (JavaScript bridge)
  ↓ Calls
Module.invoke('<?php ... ?>')
  ↓ Executes
phpboy-wasm-full.php (bundled emulator)
  ↓ Outputs
JSON (pixels, audio)
  ↓ Renders
Canvas + Web Audio API
```

## Building em

See [EM-BUILD-INSTRUCTIONS.md](../EM-BUILD-INSTRUCTIONS.md) for detailed em build instructions.

Quick summary:

```bash
# Install emscripten
git clone https://github.com/emscripten-core/emsdk.git
cd emsdk && ./emsdk install 4.0.11 && ./emsdk activate 4.0.11

# Build em
cd /tmp/em
make -f em.mk EM_PHP_DIR=/tmp/php-src with="bcmath ctype mbstring tokenizer"
```

## Performance Optimizations

### 1. Batched Frame Execution

Instead of one frame per JavaScript call:

```javascript
// OLD (php-wasm): ~40ms per frame
for (let i = 0; i < 4; i++) {
  await php.run('<?php $emulator->step(); ?>');
}

// NEW (em): ~10ms for 4 frames
await Module.invoke(`<?php
  for ($i = 0; $i < 4; $i++) {
    $emulator->step();
  }
?>`);
```

### 2. Direct VFS Access

```javascript
// Write ROM to virtual filesystem
Module.vfs.put('/rom.gb', romBytes);

// vs old Emscripten FS API
phpInstance.FS.writeFile('/rom.gb', romBytes);
```

### 3. Pre-compiled PHP Code

em's `Module.include()` loads and caches PHP code:

```javascript
// Load once
await Module.include('/phpboy-wasm.php');

// Execute repeatedly (fast)
await Module.invoke('<?php global $emulator; $emulator->step(); ?>');
```

## Deployment

### Static Hosting

The `web/` directory (with em binaries) is fully static and can be deployed to:

- GitHub Pages
- Netlify
- Vercel
- AWS S3 + CloudFront
- Any static file host

### Required Files

```
web/
├── index.html
├── php-em.js          # Required
├── php-em.wasm        # Required
├── phpboy-wasm-full.php  # Generated by make build-wasm
├── js/
│   └── phpboy.js
└── css/
    └── styles.css
```

### CORS Headers

Ensure your host sets proper CORS headers:

```
Access-Control-Allow-Origin: *
Cross-Origin-Embedder-Policy: require-corp  
Cross-Origin-Opener-Policy: same-origin
```

## Browser Compatibility

Tested browsers:

- ✅ Chrome 90+ (best performance)
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+

Requirements:
- WebAssembly support
- ES6 support
- Canvas API
- Web Audio API (for audio)

## Troubleshooting

### "Module is not defined"

**Cause:** php-em.js not loaded or loaded after phpboy.js

**Fix:** Ensure correct script order in index.html:
```html
<script src="php-em.js"></script>
<script src="js/phpboy.js"></script>
```

### "PHP startup failed"

**Cause:** em binary incompatible or corrupted

**Fix:** Rebuild em with matching Emscripten version

### Slow Performance

**Causes:**
- Missing JIT optimization in em build
- Old browser
- Too many frames per render

**Fixes:**
- Build em with opcache enabled
- Test in Chrome
- Adjust framesPerRender in phpboy.js

### Build Errors

See [EM-BUILD-INSTRUCTIONS.md](../EM-BUILD-INSTRUCTIONS.md#troubleshooting)

## Performance Metrics

Expected performance with em:

| Metric | php-wasm | em | Improvement |
|--------|----------|-----|-------------|
| FPS | 15-25 | 40-60 | 2-3x |
| Frame time | 40-60ms | 10-15ms | 4x |
| Binary size | 8MB | 4MB | 50% |
| Load time | 2-3s | 1-2s | 40% |

## Next Steps

- [ ] Build em binaries (see EM-BUILD-INSTRUCTIONS.md)
- [ ] Copy php-em.* to web/
- [ ] Run `make build-wasm`
- [ ] Test locally with `make serve-wasm`
- [ ] Deploy to static host

## Resources

- [em GitHub](https://github.com/krakjoe/em)
- [em Migration Guide](em-migration.md)
- [Emscripten Docs](https://emscripten.org/)
- [WebAssembly Docs](https://webassembly.org/)

## Credits

- **em** by krakjoe (Joe Watkins)
- **PHP** by the PHP Team
- **Emscripten** by the Emscripten Team
